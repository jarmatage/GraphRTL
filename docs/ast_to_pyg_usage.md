# AST to PyTorch Geometric Converter

This module provides functionality to convert Verilog AST (Abstract Syntax Tree) from pyverilog into PyTorch Geometric graph representations.

## Overview

The `ast_to_pyg` module takes a Verilog file, parses it using pyverilog, and converts it into a graph representation suitable for use with PyTorch Geometric (PyG) for machine learning applications.

## Key Components

### Classes

1. **`DirectedGraph`**: A simple directed graph implementation for intermediate representation
   - Manages nodes and edges
   - Provides methods for adding/removing nodes and edges
   - Tracks node neighbors

2. **`ASTToPyG`**: Main converter class that transforms AST to PyG Data objects
   - Traverses the pyverilog AST
   - Builds an intermediate graph representation
   - Eliminates wire nodes (intermediate signals)
   - Converts to PyTorch Geometric Data format

### Functions

- **`convert_verilog_to_pyg(verilog_file: str) -> Data`**: Convenience function to convert a Verilog file directly to a PyG graph

## Usage

### Basic Usage

```python
from graphrtl.sog import convert_verilog_to_pyg

# Convert a Verilog file to PyG graph
data = convert_verilog_to_pyg("path/to/your/design.v")

# Access the graph data
print(f"Number of nodes: {data.x.shape[0]}")
print(f"Number of edges: {data.edge_index.shape[1]}")
print(f"Node features shape: {data.x.shape}")
print(f"Node names: {data.node_names}")
print(f"Node types: {data.node_types}")
```

### Advanced Usage with Direct AST

```python
from pyverilog.vparser.parser import parse
from graphrtl.sog import ASTToPyG

# Parse the Verilog file
ast, _ = parse(["path/to/your/design.v"])

# Create converter and convert
converter = ASTToPyG(ast)
data = converter.convert()

# Access intermediate graph if needed
graph = converter.graph
print(f"Nodes in intermediate graph: {len(graph.node_dict)}")
```

### Using DirectedGraph and SOGNode

```python
from graphrtl.sog import DirectedGraph, SOGNode

# Create a graph manually
graph = DirectedGraph()

# Create nodes
node1 = SOGNode(name="input_a", type="Input", bit_width=8)
node2 = SOGNode(name="output_z", type="Output", bit_width=8)

# Add nodes to graph
graph.add_node("input_a", node1)
graph.add_node("output_z", node2)

# Add edge from input to output
graph.add_edge("input_a", "output_z")
```

## Features

### Supported Verilog Constructs

- **Declarations**: Wire, Reg, Input, Output
- **Assignments**: Blocking (`=`) and Non-blocking (`<=`)
- **Operators**: Arithmetic, logical, bitwise, comparison, shift
- **Control Flow**: If-else statements, case statements
- **Data Operations**: Concatenation, part-select, pointer operations

### Graph Processing

1. **AST Traversal**: Recursively traverses the pyverilog AST
2. **Node Creation**: Creates nodes for:
   - Declarations (wires, registers, ports)
   - Operators (arithmetic, logical, etc.)
   - Constants
   - Multiplexers (from if-else and case statements)

3. **Wire Elimination**: Removes intermediate wire nodes by connecting their inputs directly to outputs

4. **PyG Conversion**: Converts to PyTorch Geometric format with:
   - Node features: `[bit_width, fanout, toggle_rate]`
   - Edge index: Standard PyG edge representation
   - Metadata: Node names and types

## Node Features

Each node in the graph has the following features:
- **bit_width**: Width of the signal in bits
- **fanout**: Number of downstream connections (default: 1)
- **toggle_rate**: Signal transition rate (default: 0.5)

Additional node attributes stored as metadata:
- **name**: Unique identifier for the node
- **type**: Type of node (Wire, Reg, Operator, Constant, Mux, etc.)

## Example with SOG Verilog

For a Simple Operator Graph (SOG) Verilog file generated by Yosys:

```python
from graphrtl.sog import convert_verilog_to_pyg

# Convert SOG Verilog to graph
data = convert_verilog_to_pyg("design.sog.v")

# The resulting graph has:
# - Nodes representing operators, registers, and wires
# - Edges representing data flow
# - Features suitable for ML models
```

## Integration with PyTorch Geometric

The output `Data` object is fully compatible with PyTorch Geometric:

```python
from torch_geometric.loader import DataLoader
from torch_geometric.nn import GCNConv

# Use in a GNN model
data = convert_verilog_to_pyg("design.v")

# Create a simple GCN
class GNN(torch.nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = GCNConv(3, 16)  # 3 input features
        self.conv2 = GCNConv(16, 8)
    
    def forward(self, data):
        x, edge_index = data.x, data.edge_index
        x = self.conv1(x, edge_index).relu()
        x = self.conv2(x, edge_index)
        return x

model = GNN()
output = model(data)
```

## Reference

This module was inspired by the AST analyzer from MasterRTL, adapted for use with GraphRTL and PyTorch Geometric.
